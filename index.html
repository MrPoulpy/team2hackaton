<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>Chess</title>
		<link rel="stylesheet" href="css/chessboard-0.3.0.css" />
		<link rel="stylesheet" href="css/main.css" />

		<script src="js/chess.js"></script>
		<script src="js/json3.min.js"></script>
		<script src="js/jquery-1.10.1.min.js"></script>
		<script src="js/chessboard-0.3.0.js"></script>
	</head>
	<body>
		<div id="board" style="width: 400px"></div>
		
<input type="button" id="ruyLopezBtn" value="Ruy Lopez" />
	</body>
	<script>
var game;
var cfg = {
	draggable: true,
	position: 'r1bqkbnr/pppp1ppp/2n5/1B2p3/4P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 0 1',
	ai: true,
	highlight: true
};

var init = function() {
	
	var board;
	var boardEl = $('#board');
	game = new Chess(cfg.position);
	var squareToHighlight;

	var removeGreySquares = function() {
		$('#board .square-55d63').css('background', '');
	};

	var greySquare = function(square) {
		var squareEl = $('#board .square-' + square);
  
		var background = '#a9a9a9';
		if (squareEl.hasClass('black-3c85d') === true) {
			background = '#696969';
		}

		squareEl.css('background', background);
	};
	
	var removeHighlights = function(color) {
		boardEl.find('.square-55d63').removeClass('highlight-' + color);
	};

	var onDragStart = function(source, piece, position, orientation) {
		if (game.in_checkmate() === true || game.in_draw() === true || piece.search(/^b/) !== -1) {
			return (false);
		}
	};

	var makeRandomMove = function() {
		var possibleMoves = game.moves({
			verbose: true
		});

		// game over
		if (possibleMoves.length === 0) {
			if (game.in_checkmate())
				console.log("win");
			else
				console.log("pat");
			return;
		}

		var randomIndex = Math.floor(Math.random() * possibleMoves.length);
		var move = possibleMoves[randomIndex];
		game.move(move.san);

		// highlight black's move
		removeHighlights('black');
		boardEl.find('.square-' + move.from).addClass('highlight-black');
		squareToHighlight = move.to;

		// update the board to the new position
		board.position(game.fen());
		var possibleMoves = game.moves({
			verbose: true
		});

		// game over
		if (possibleMoves.length === 0) {
			if (game.in_checkmate())
				console.log("lose");
			else
				console.log("pat");
			return;
		}
	};

	var onDrop = function(source, target) {
		 removeGreySquares();
	
		// see if the move is legal
		var move = game.move({
			from: source,
			to: target,
			promotion: 'q' // NOTE: always promote to a queen for example simplicity
		});

		// illegal move
		if (move === null) return 'snapback';

		// highlight white's move
		removeHighlights('white');
		boardEl.find('.square-' + source).addClass('highlight-white');
		boardEl.find('.square-' + target).addClass('highlight-white');

		// make random move for black
		if (cfg.ai == false) {
			game.load(game.fen().replace(' b ', ' w '));
			removeHighlights('black');
		} else
			window.setTimeout(makeRandomMove, 250);
		
	};
	
	var onMouseoverSquare = function(square, piece) {
		if (cfg.highlight == false)
			return ;
		// get list of possible moves for this square
		var moves = game.moves({
			square: square,
			verbose: true
		});

		// exit if there are no moves available for this square
		if (moves.length === 0) return;

		// highlight the square they moused over
		greySquare(square);

		// highlight the possible squares for this piece
		for (var i = 0; i < moves.length; i++) {
			greySquare(moves[i].to);
		}
	};
	
	var onMouseoutSquare = function(square, piece) {
		removeGreySquares();
	};

	var onMoveEnd = function() {
		boardEl.find('.square-' + squareToHighlight).addClass('highlight-black');
	};

	// update the board position after the piece snap
	// for castling, en passant, pawn promotion
	var onSnapEnd = function() {
		board.position(game.fen());
	};

	cfg.onDragStart = onDragStart;
	cfg.onDrop = onDrop;
	cfg.onMoveEnd = onMoveEnd;
	cfg.onSnapEnd = onSnapEnd;
	cfg.onMouseoutSquare = onMouseoutSquare;
	cfg.onMouseoverSquare = onMouseoverSquare;
	board = new ChessBoard('board', cfg);
};

$(document).ready(init);
	</script>
</html>